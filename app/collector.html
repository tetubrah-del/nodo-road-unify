<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Nodo Collector</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { height:60%; }
    #controls { padding:12px; background:#f5f5f5; display:flex; flex-direction:column; gap:8px; }
    #status { font-weight:bold; color:#333; }
    #points-count { font-size:14px; color:#555; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="startBtn">記録開始</button>
      <button id="stopSendBtn" disabled>記録停止＆送信</button>
    </div>
    <div id="points-count">記録ポイント数: 0</div>
    <div id="status">待機中</div>
    <div style="font-size:12px; color:#777;">ブラウザの位置情報を許可してから記録してください。</div>
  </div>

  <script>
    const map = L.map("map").setView([33.1471, 131.5218], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
    }).addTo(map);

    let watchId = null;
    let recordedPoints = [];
    let polyline = null;

    const startBtn = document.getElementById("startBtn");
    const stopSendBtn  = document.getElementById("stopSendBtn");
    const statusEl = document.getElementById("status");
    const pointsCountEl = document.getElementById("points-count");

    function updatePointsCount() {
      pointsCountEl.textContent = `記録ポイント数: ${recordedPoints.length}`;
    }

    function resetRecording() {
      recordedPoints = [];
      updatePointsCount();
      if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
      }
    }

    startBtn.onclick = () => {
      resetRecording();
      statusEl.textContent = "GPS記録中...";
      startBtn.disabled = true;
      stopSendBtn.disabled = false;

      if (!navigator.geolocation) {
        alert("この端末はGPSが使えません");
        statusEl.textContent = "GPS非対応";
        startBtn.disabled = false;
        stopSendBtn.disabled = true;
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const point = { lat, lon, ts: new Date().toISOString() };
          recordedPoints.push(point);
          updatePointsCount();

          if (!polyline) {
            polyline = L.polyline([[lat, lon]], { color: "blue" }).addTo(map);
          } else {
            polyline.addLatLng([lat, lon]);
          }
        },
        (err) => {
          console.error(err);
          alert("位置情報が取得できません: " + err.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000,
        }
      );
    };

    stopSendBtn.onclick = async () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (recordedPoints.length < 2) {
        alert("2ポイント以上記録してから送信してください");
        statusEl.textContent = "記録が少なすぎます";
        startBtn.disabled = false;
        stopSendBtn.disabled = true;
        return;
      }

      statusEl.textContent = "送信中...";
      try {
        const res = await fetch('/api/gps_tracks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ points: recordedPoints, meta: { client: 'pwa_v1' } })
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.detail || '送信に失敗しました');
        }
        statusEl.textContent = `送信完了。link_id=${data.inserted_link_id}, danger_score=${data.danger_score}`;
        resetRecording();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "送信エラー: " + e.message;
      }

      startBtn.disabled = false;
      stopSendBtn.disabled = true;
    };
  </script>

  <!-- Self-review:
       - /api/gps_tracks で GPS ポイントを受け取り、road_links に source='gps_mobile' で1本の LINESTRING として挿入し、簡易な曲がり具合ベースの danger_score を付与するようにした。
       - collector.html にブラウザの geolocation API を使った Start/Stop ロガーと、API への送信処理を追加した。

       Testing:
       - ローカルで `uvicorn main:app --reload` を起動。
       - ブラウザで `http://localhost:8000/collector` を開き、屋外 or 擬似位置情報で「記録開始」→少し移動→「記録停止＆送信」を実行。
       - サーバのログで `/api/gps_tracks` のリクエストが成功し、レスポンス JSON に `status: ok` と `danger_score` が含まれていることを確認。
       - `/map` を開き、GPS レイヤー（青）の中に、新しいログの LINESTRING が描画されていることを確認。
  -->
</body>
</html>
